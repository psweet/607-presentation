---
title: "Heatmaps in R"
author: "Kayvan Jalali & Carlos Puerta"
date: "9/20/2023"
output:
  beamer_presentation:
    keep_tex: no
    theme: CambridgeUS
    slide_level: 2
    incremental: no
fontsize: 10pt
classoption: compress
header-includes:
  \hypersetup{colorlinks,citecolor=orange,filecolor=red,linkcolor=brown,urlcolor=blue}
  \usepackage{amsmath,color,amsthm,amssymb,pdfpages,algorithm2e,dsfont}
  \newcommand{\vv}{\vspace{2mm}}
  \newcommand{\p}{\mathbb{P}}
  \newcommand{\e}{\mathbb{E}}
  \newcommand{\etr}{\overline{\text{err}}}
  \newcommand{\ete}{\text{Err}_{\mathcal{T}}}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(dev = "pdf")

library(nycflights13)
library(ggplot2)
library(pheatmap)
library(tidyverse)
```

```{r, echo=FALSE}

## ggplot dummy data
x = LETTERS[1:5]
y = paste0("var", seq(1, 5))
data = expand.grid(X = x, Y = y)
data$Z = runif(25, 0, 5)

## Pheat dummy data
test = matrix(rnorm(25), 20, 10)
test[1:10, seq(1, 10, 2)] = test[1:10, seq(1, 10, 2)] + 3
test[11:20, seq(2, 10, 2)] = test[11:20, seq(2, 10, 2)] + 2
test[15:20, seq(2, 10, 2)] = test[15:20, seq(2, 10, 2)] + 4
colnames(test) = paste("Test", 1:10, sep = "")
rownames(test) = paste("Gene", 1:20, sep = "")

```

\tableofcontents

# What is a heatmap?

A heatmap is graphic that will display your data in a colorful grid. This is great for seeing trends and patterns in your data.

Generally, heatmaps are used to represent data where you have 2 categorical variables with a third continuous variable, though this is not explicitly necessary.

### Advantages
\begin{itemize}
  \item Adds another variable
  \item Easier to interpret
  \item Color is easy to parse
\end{itemize}
 
### Disadvantages
\begin{itemize}
  \item Need right choice of colors and data 
  \item Only useful if clear 
  \item A different plot may be better
\end{itemize}

## Examples

```{r, echo=FALSE, fig.width = 2.3, fig.height = 2.3, warning=FALSE, message=FALSE}
ggplot(data, aes(X, Y, fill = Z)) +
  geom_tile() + coord_equal() + theme_minimal()

ggplot(mtcars, aes(x = wt, y = mpg, fill = disp)) +
  geom_point(shape = 21) + theme_minimal()
```

## When to use a heatmap

Heatmaps are applicable to both continuous and discrete variables. When working with discrete variables, distinguishing between similar colors can be challenging. To improve visibility, it is recommended to use a color palette of no more than nine colors, such as ROYGBIV, black, and white.

In the case of continuous variables, you have the option to use a sequential 
color scale, transitioning from a lighter hue to a darker one or vice versa. 
Alternatively, you can create a divergent color scale, transitioning between two distinct colors. A divergent color scale may be more useful when the center and ends
of the value range are meaning full. 

## ggplot2

You can create a simple and quick heatmap using the geom_tile() function in ggplot2, but these heatmaps are very limited in their functionality.

```{r, echo=TRUE, fig.width = 10, fig.height=3, warning=FALSE, message=FALSE}
ggplot(data, aes(X, Y, fill = Z)) +
  geom_tile() + coord_equal()
```

# Pheatmap Package

Pheatmap (Pretty Heatmaps) is a package for R that supercharges heatmaps and allows you to create incredibly complex and helpful heatmaps.

## Basic functions

```{r}
pheatmap(test)
pheatmap(test, kmeans_k = 2)
pheatmap(test, scale = "row", clustering_distance_rows = "correlation")
pheatmap(test, color = colorRampPalette(c("navy", "white", "firebrick3"))(50))
pheatmap(test, cluster_row = FALSE)
pheatmap(test, legend = FALSE)
pheatmap(test, display_numbers = TRUE)
pheatmap(test, display_numbers = TRUE, number_format = "%.1e")
pheatmap(test, cluster_row = FALSE, legend_breaks = -1:4, legend_labels = c("0",
"1e-4", "1e-3", "1e-2", "1e-1", "1"))
pheatmap(test, cellwidth = 15, cellheight = 12, main = "Example heatmap")
```

## Dendogram

## Pheatmap example

```{r,include=FALSE}

# cont. example data 
n <- 10
x1 = matrix(1:n,nrow=n)
x2 = matrix(1:n,nrow=1)

x3 = x1 %*% x2 # dim will be nxn

#making matrix for discrete demonstration 
filler = rep(0,25)
fill_mat = matrix(filler,nrow=5)
f1 = cbind(fill_mat,fill_mat+1)
f2 = cbind(fill_mat+2,fill_mat+3)
disc_mat = rbind(f1,f2)

```

```{r}
# example why divergent palette is not good 
pheatmap(x3,
         cluster_rows = FALSE,
         cluster_cols = FALSE,
          color = colorRampPalette(c("blue", "white", "red"))(100))

```

## Pheatmap example

```{r}

# example why sequential palette is good 
pheatmap(x3,
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         color = colorRampPalette(c( "white", "red"))(100),
         display_numbers = round(var(x3)) )


```

## Pheatmap example

```{r}

# discrete example 
pheatmap(disc_mat, 
         cluster_rows = FALSE,
         cluster_cols = FALSE,,
         color=c('blue','red','yellow',1) )

```


## More Complex Example

## Genes

\begin{figure}
  \centering
  \includegraphics[width=0.5\columnwidth]{figures/genes.png}
\end{figure}

## Code for Genes


```{r, echo=TRUE, warning=FALSE, message=FALSE,eval=FALSE}
topGenes = order(rowVars(Biobase::exprs(x)), 
                 decreasing = TRUE)[1:500]
rowCenter = function(x) { x - rowMeans(x) }

pheatmap(rowCenter(dfx[topGenes, ]), 
  show_rownames = FALSE, 
  show_colnames = FALSE, 
  breaks = seq(-5, +5, length = 101),
  annotation_col = pData(x)[, c("sampleGroup", 
                                "Embryonic.day", 
                                "ScanDate", 
                                "genotype") ],
  annotation_colors = list(
    sampleGroup = groupColor,
    genotype = c(`FGF4-KO` = "chocolate1", `WT` = "azure2"),
    Embryonic.day = setNames(brewer.pal(9, "Blues")[c(3, 6, 9)], 
                             c("E3.25", "E3.5", "E4.5")),
    ScanDate = setNames(brewer.pal(nlevels(x$ScanDate), "YlGn"), 
                        levels(x$ScanDate))
  )
)
```

# Applying Heatmaps

## NYC13Flights

First we get our data ready.

```{r, echo=TRUE, warning=FALSE, message=FALSE}
x <- flights %>%
  filter(arr_delay > 0) %>%
  group_by(month, carrier) %>%
  summarize(total_delay = sum(arr_delay / 60)) %>%
  arrange(month, carrier)
```

## NYC13Flights

Then we transform it into a matrix for Pheatmap.
```{r, echo=TRUE, fig.width = 10, fig.height=4.5, warning=FALSE, message=FALSE}
mat <- matrix(x$total_delay, nrow = 16)
rownames(mat) <- unique(x$carrier)
colnames(mat) <- unique(x$month)
```

## NYC13Flights
And finally we plot it.

```{r, echo=TRUE, eval=FALSE, fig.width = 10, fig.height=4.5, warning=FALSE, message=FALSE}
pheatmap(mat,
  cluster_row = FALSE,
  cluster_cols = FALSE,
  legend_breaks = c(150, 1200, 2300),
  legend_labels = c("Low", "Medium", "High")
)
```

## NYC13Flights
```{r, echo=FALSE, fig.width = 10, fig.height=4.5, warning=FALSE, message=FALSE}
pheatmap(mat,
  cluster_row = FALSE,
  cluster_cols = FALSE,
  legend_breaks = c(150, 1200, 2300),
  legend_labels = c("Low", "Medium", "High")
)
```

## MPG

Let's do it with a simpler dataset we're familiar with. We start by getting summarizing our data.
```{r, echo=TRUE, warning=FALSE, message=FALSE}
x <- mpg %>%
  group_by(year, manufacturer) %>%
  mutate(avg_mpg = (cty + hwy) / 2) %>%
  summarize(avg_mpg = mean(avg_mpg)) %>%
  arrange(year, manufacturer)
```
We create a matrix and then plot it.
```{r, echo=TRUE, eval=FALSE, warning=FALSE, message=FALSE}
mat <- matrix(x$avg_mpg, nrow = 15)
rownames(mat) <- unique(x$manufacturer)
colnames(mat) <- unique(x$year)
pheatmap(mat,
  color = colorRampPalette(
    c("red", "orange", "yellow", "darkgreen")
  )(1000),
)
```

## MPG
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height=6.5}
mat <- matrix(x$avg_mpg, nrow = 15)
rownames(mat) <- unique(x$manufacturer)
colnames(mat) <- unique(x$year)
pheatmap(mat,
  color = colorRampPalette(
    c("red", "orange", "yellow", "darkgreen")
  )(1000),
)
```

# Wrapping up
